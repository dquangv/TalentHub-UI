<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P @Quang Bui</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Th√™m th∆∞ vi·ªán n√©n LZ-String -->
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <style>
        .role-specific {
            display: none;
        }

        .role-instructions {
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
            padding: 10px;
            margin-bottom: 15px;
        }

        .debug-info {
            margin-top: 5px;
            font-size: 0.8rem;
            text-align: right;
        }

        #debugSection {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            display: none;
        }

        #debugInfo {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>

<body class="container py-4">
    <h2 class="text-center mb-4">P2P @Quang Bui</h2>

    <!-- Ch·ªçn vai tr√≤ -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Ch·ªçn vai tr√≤ c·ªßa b·∫°n</h5>
        </div>
        <div class="card-body">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="role" id="roleCaller" value="caller" checked
                    onchange="updateRoleUI()">
                <label class="form-check-label" for="roleCaller">Ng∆∞·ªùi g·ªçi (b·∫Øt ƒë·∫ßu cu·ªôc g·ªçi)</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="role" id="roleReceiver" value="receiver"
                    onchange="updateRoleUI()">
                <label class="form-check-label" for="roleReceiver">Ng∆∞·ªùi nh·∫≠n (nh·∫≠n cu·ªôc g·ªçi)</label>
            </div>

            <!-- N√∫t hi·ªÉn th·ªã debug -->
            <div class="float-end">
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleDebug()">‚öôÔ∏è Debug</button>
            </div>
        </div>
    </div>

    <div id="status" class="alert alert-info text-center">B∆∞·ªõc 1: B·∫≠t Camera</div>

    <!-- H∆∞·ªõng d·∫´n theo vai tr√≤ -->
    <div id="callerInstructions" class="role-instructions">
        <h5>H∆∞·ªõng d·∫´n cho Ng∆∞·ªùi g·ªçi:</h5>
        <ol>
            <li>B·∫≠t camera</li>
            <li>T·∫°o l·ªùi m·ªùi</li>
            <li>Sao ch√©p l·ªùi m·ªùi v√† g·ª≠i cho ƒë·ªëi t√°c</li>
            <li>ƒê·ª£i nh·∫≠n ph·∫£n h·ªìi t·ª´ ƒë·ªëi t√°c</li>
            <li>D√°n ph·∫£n h·ªìi v√†o √¥ "Ph·∫£n H·ªìi"</li>
            <li>Nh·∫•n "ƒê·∫∑t Ph·∫£n H·ªìi" ƒë·ªÉ k·∫øt n·ªëi</li>
        </ol>
    </div>

    <div id="receiverInstructions" class="role-instructions" style="display: none;">
        <h5>H∆∞·ªõng d·∫´n cho Ng∆∞·ªùi nh·∫≠n:</h5>
        <ol>
            <li>B·∫≠t camera</li>
            <li>D√°n l·ªùi m·ªùi nh·∫≠n ƒë∆∞·ª£c v√†o √¥ "L·ªùi M·ªùi"</li>
            <li>Nh·∫•n "T·∫°o Ph·∫£n H·ªìi"</li>
            <li>Sao ch√©p ph·∫£n h·ªìi v√† g·ª≠i l·∫°i cho ng∆∞·ªùi g·ªçi</li>
            <li>ƒê·ª£i k·∫øt n·ªëi ƒë∆∞·ª£c thi·∫øt l·∫≠p</li>
        </ol>
    </div>

    <div class="row text-center">
        <div class="col-md-6">
            <h5>Video C·ªßa B·∫°n</h5>
            <video id="localVideo" class="border w-100" autoplay playsinline muted></video>
        </div>
        <div class="col-md-6">
            <h5>Video ƒê·ªëi T√°c</h5>
            <video id="remoteVideo" class="border w-100" autoplay playsinline></video>
        </div>
    </div>

    <div class="text-center mt-3">
        <button id="startBtn" class="btn btn-primary m-2" onclick="start()">1. B·∫≠t Camera</button>
        <button id="offerBtn" class="btn btn-success m-2 role-specific caller-btn" onclick="createOffer()" disabled>2.
            T·∫°o L·ªùi M·ªùi</button>
        <button id="answerBtn" class="btn btn-warning m-2 role-specific receiver-btn" onclick="createAnswer()" disabled
            style="display: none;">2. T·∫°o Ph·∫£n H·ªìi</button>
        <button id="endCallBtn" class="btn btn-danger m-2" onclick="endCall()" disabled>üî¥ K·∫øt Th√∫c Cu·ªôc G·ªçi</button>
    </div>

    <div class="mt-3">
        <label class="form-label">L·ªùi M·ªùi: <span class="text-muted">(Sao ch√©p v√† g·ª≠i cho ƒë·ªëi t√°c)</span></label>
        <textarea id="offer" class="form-control" rows="3" placeholder="D√°n l·ªùi m·ªùi v√†o ƒë√¢y"
            oninput="validateContent()"></textarea>
        <div class="mt-2 d-flex justify-content-between">
            <button class="btn btn-sm btn-outline-secondary" onclick="showDebugInfo('offer')">Ki·ªÉm tra ƒë·ªãnh
                d·∫°ng</button>
            <button id="copyOfferBtn" class="btn btn-info role-specific caller-btn" onclick="copyToClipboard('offer')"
                disabled>üìã Sao ch√©p L·ªùi M·ªùi</button>
        </div>
    </div>

    <div class="mt-3">
        <label class="form-label">Ph·∫£n H·ªìi: <span class="text-muted">(Sao ch√©p v√† g·ª≠i cho ng∆∞·ªùi g·ªçi)</span></label>
        <textarea id="answer" class="form-control" rows="3" placeholder="D√°n ph·∫£n h·ªìi v√†o ƒë√¢y"
            oninput="validateContent()"></textarea>
        <div class="mt-2 d-flex justify-content-between">
            <button class="btn btn-sm btn-outline-secondary" onclick="showDebugInfo('answer')">Ki·ªÉm tra ƒë·ªãnh
                d·∫°ng</button>
            <div>
                <button id="copyAnswerBtn" class="btn btn-info role-specific receiver-btn"
                    onclick="copyToClipboard('answer')" disabled style="display: none;">üìã Sao ch√©p Ph·∫£n H·ªìi</button>
                <button id="setAnswerBtn" class="btn btn-secondary role-specific caller-btn" onclick="setAnswer()"
                    disabled>3. ƒê·∫∑t Ph·∫£n H·ªìi</button>
            </div>
        </div>
    </div>

    <!-- Khu v·ª±c debug -->
    <div id="debugSection">
        <h5>Th√¥ng tin Debug</h5>
        <div class="mb-2">
            <button class="btn btn-sm btn-outline-primary" onclick="forceJSON()">Chuy·ªÉn ƒë·ªïi sang JSON thu·∫ßn t√∫y</button>
            <button class="btn btn-sm btn-outline-primary" onclick="forceBase64()">Chuy·ªÉn ƒë·ªïi sang Base64</button>
            <button class="btn btn-sm btn-outline-primary" onclick="forceCompression()">B·∫≠t/T·∫Øt N√©n</button>
            <button class="btn btn-sm btn-outline-danger" onclick="clearDebugLog()">X√≥a log</button>
        </div>
        <div class="alert alert-secondary">
            <div id="debugInfo" class="small">Ch∆∞a c√≥ th√¥ng tin debug</div>
        </div>
        <div class="mb-2">
            <label class="form-label">Tr·∫°ng th√°i k·∫øt n·ªëi:</label>
            <div id="connectionState" class="alert alert-light">Ch∆∞a c√≥ k·∫øt n·ªëi</div>
        </div>
    </div>

    <footer class="text-center mt-4">S·∫£n ph·∫©m b·ªüi Quang Bui</footer>

    <script>
        let localStream;
        let peerConnection;
        let localICECandidates = [];
        let role = "caller"; // M·∫∑c ƒë·ªãnh l√† ng∆∞·ªùi g·ªçi
        let lastOfferData = null;
        let lastAnswerData = null;
        let useBase64 = true; // M·∫∑c ƒë·ªãnh s·ª≠ d·ª•ng Base64
        let useCompression = true; // M·∫∑c ƒë·ªãnh s·ª≠ d·ª•ng n√©n
        let maxCandidates = 3; // S·ªë l∆∞·ª£ng ICE candidates t·ªëi ƒëa
        let collectCandidatesTime = 1000; // Th·ªùi gian thu th·∫≠p ICE candidates (ms)
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

        // Hi·ªÉn th·ªã/·∫©n khu v·ª±c debug
        function toggleDebug() {
            const debugSection = document.getElementById('debugSection');
            if (debugSection.style.display === 'none' || !debugSection.style.display) {
                debugSection.style.display = 'block';
            } else {
                debugSection.style.display = 'none';
            }
        }

        // X√≥a log debug
        function clearDebugLog() {
            document.getElementById('debugInfo').innerHTML = 'Log ƒë√£ ƒë∆∞·ª£c x√≥a';
        }

        // C·∫≠p nh·∫≠t th√¥ng tin debug
        function updateDebugInfo(message) {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML = `[${timestamp}] ${message}<br>` + debugInfo.innerHTML;
        }

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i k·∫øt n·ªëi
        function updateConnectionState(state) {
            const connectionState = document.getElementById('connectionState');
            connectionState.textContent = state;

            // ƒê·ªïi m√†u theo tr·∫°ng th√°i
            connectionState.className = 'alert';
            switch (state) {
                case 'connected':
                case 'completed':
                    connectionState.classList.add('alert-success');
                    break;
                case 'connecting':
                case 'checking':
                    connectionState.classList.add('alert-info');
                    break;
                case 'disconnected':
                case 'failed':
                    connectionState.classList.add('alert-danger');
                    break;
                default:
                    connectionState.classList.add('alert-light');
            }
        }

        // Chuy·ªÉn ƒë·ªïi sang ƒë·ªãnh d·∫°ng JSON thu·∫ßn t√∫y
        function forceJSON() {
            useBase64 = false;
            updateDebugInfo("ƒê√£ chuy·ªÉn sang ƒë·ªãnh d·∫°ng JSON thu·∫ßn t√∫y");
        }

        // Chuy·ªÉn ƒë·ªïi sang ƒë·ªãnh d·∫°ng Base64
        function forceBase64() {
            useBase64 = true;
            updateDebugInfo("ƒê√£ chuy·ªÉn sang ƒë·ªãnh d·∫°ng Base64");
        }

        // B·∫≠t/t·∫Øt n√©n
        function forceCompression() {
            useCompression = !useCompression;
            updateDebugInfo(`ƒê√£ ${useCompression ? 'b·∫≠t' : 't·∫Øt'} t√≠nh nƒÉng n√©n d·ªØ li·ªáu`);
        }

        // L·ªçc ICE candidates
        function filterICECandidates(candidates) {
            if (!candidates || candidates.length === 0) return [];

            // ∆Øu ti√™n candidate lo·∫°i host v√† srflx (STUN)
            return candidates.filter(candidate => {
                if (!candidate || !candidate.candidate) return false;
                return candidate.candidate.includes('typ host') ||
                    candidate.candidate.includes('typ srflx');
            }).slice(0, maxCandidates); // Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng
        }

        // M√£ h√≥a d·ªØ li·ªáu v·ªõi ƒë·ªãnh d·∫°ng t·ªëi ∆∞u
        function encodeData(data) {
            // T·ªëi ∆∞u h√≥a d·ªØ li·ªáu
            const optimizedData = {
                s: data.sdp, // SDP
                i: filterICECandidates(data.iceCandidates), // ICE candidates ƒë√£ l·ªçc
                t: Date.now() // Timestamp ng·∫Øn g·ªçn
            };

            // Chuy·ªÉn th√†nh chu·ªói JSON
            const jsonString = JSON.stringify(optimizedData);

            // N√©n d·ªØ li·ªáu n·∫øu ƒë∆∞·ª£c b·∫≠t
            if (useCompression) {
                return LZString.compressToBase64(jsonString);
            }

            // M√£ h√≥a d·ª±a v√†o c√†i ƒë·∫∑t
            if (useBase64) {
                return btoa(jsonString);
            } else {
                return jsonString;
            }
        }

        // Gi·∫£i m√£ d·ªØ li·ªáu v·ªõi x·ª≠ l√Ω nhi·ªÅu ƒë·ªãnh d·∫°ng
        async function decodeData(input) {
            try {
                input = input.trim();
                let jsonString = '';

                // Th·ª≠ gi·∫£i m√£ v·ªõi LZ-String tr∆∞·ªõc
                try {
                    jsonString = LZString.decompressFromBase64(input);
                    // N·∫øu gi·∫£i n√©n th√†nh c√¥ng v√† l√† chu·ªói h·ª£p l·ªá
                    if (jsonString && typeof jsonString === 'string' && jsonString.length > 0) {
                        const data = JSON.parse(jsonString);
                        // N·∫øu c√≥ ƒë·ªãnh d·∫°ng t·ªëi ∆∞u
                        if (data.s && (data.i || data.i === [])) {
                            return {
                                sdp: data.s,
                                iceCandidates: data.i,
                                timestamp: data.t ? new Date(data.t).toISOString() : new Date().toISOString()
                            };
                        }
                    }
                } catch (e) {
                    // Kh√¥ng ph·∫£i LZ-String, th·ª≠ c√°c ph∆∞∆°ng ph√°p kh√°c
                }

                // Th·ª≠ ph√¢n t√≠ch nh∆∞ JSON thu·∫ßn t√∫y
                try {
                    const data = JSON.parse(input);
                    if (data.s || data.sdp) {
                        return {
                            sdp: data.s || data.sdp,
                            iceCandidates: data.i || data.iceCandidates || [],
                            timestamp: data.t ? new Date(data.t).toISOString() :
                                (data.timestamp || new Date().toISOString())
                        };
                    }
                    return data;
                } catch (e) {
                    // Kh√¥ng ph·∫£i JSON, th·ª≠ gi·∫£i m√£ Base64
                    try {
                        const decoded = atob(input);
                        const data = JSON.parse(decoded);
                        if (data.s || data.sdp) {
                            return {
                                sdp: data.s || data.sdp,
                                iceCandidates: data.i || data.iceCandidates || [],
                                timestamp: data.t ? new Date(data.t).toISOString() :
                                    (data.timestamp || new Date().toISOString())
                            };
                        }
                        return data;
                    } catch (e2) {
                        throw new Error("ƒê·ªãnh d·∫°ng kh√¥ng h·ª£p l·ªá. Kh√¥ng ph·∫£i JSON, Base64 ho·∫∑c LZString.");
                    }
                }
            } catch (err) {
                updateDebugInfo("L·ªói gi·∫£i m√£: " + err.message);
                throw err;
            }
        }

        // C·∫≠p nh·∫≠t giao di·ªán theo vai tr√≤
        function updateRoleUI() {
            role = document.querySelector('input[name="role"]:checked').value;

            // Hi·ªÉn th·ªã/·∫©n h∆∞·ªõng d·∫´n
            document.getElementById('callerInstructions').style.display = role === "caller" ? "block" : "none";
            document.getElementById('receiverInstructions').style.display = role === "receiver" ? "block" : "none";

            // Hi·ªÉn th·ªã/·∫©n c√°c n√∫t cho ng∆∞·ªùi g·ªçi
            document.querySelectorAll('.caller-btn').forEach(btn => {
                btn.style.display = role === "caller" ? "inline-block" : "none";
            });

            // Hi·ªÉn th·ªã/·∫©n c√°c n√∫t cho ng∆∞·ªùi nh·∫≠n
            document.querySelectorAll('.receiver-btn').forEach(btn => {
                btn.style.display = role === "receiver" ? "inline-block" : "none";
            });

            // Reset tr·∫°ng th√°i c√°c n√∫t
            validateContent();

            // C·∫≠p nh·∫≠t h∆∞·ªõng d·∫´n d·ª±a tr√™n vai tr√≤
            if (role === "caller") {
                updateStatus("B∆∞·ªõc 1: B·∫≠t Camera (Ng∆∞·ªùi g·ªçi)");
            } else {
                updateStatus("B∆∞·ªõc 1: B·∫≠t Camera (Ng∆∞·ªùi nh·∫≠n)");
            }
        }

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i
        function updateStatus(message) {
            document.getElementById('status').innerText = message;
        }

        // Kh·ªüi ƒë·ªông camera
        async function start() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;

                if (role === "caller") {
                    document.getElementById('offerBtn').disabled = false;
                    updateStatus("B∆∞·ªõc 2: T·∫°o L·ªùi M·ªùi (Ng∆∞·ªùi g·ªçi)");
                } else {
                    updateStatus("B∆∞·ªõc 2: D√°n L·ªùi M·ªùi v√† T·∫°o Ph·∫£n H·ªìi (Ng∆∞·ªùi nh·∫≠n)");
                }

                // K√≠ch ho·∫°t n√∫t t·∫°o ph·∫£n h·ªìi n·∫øu c√≥ l·ªùi m·ªùi v√† l√† ng∆∞·ªùi nh·∫≠n
                validateContent();

                updateDebugInfo("ƒê√£ b·∫≠t camera th√†nh c√¥ng");
            } catch (err) {
                console.error("Kh√¥ng th·ªÉ truy c·∫≠p thi·∫øt b·ªã:", err);
                updateStatus("L·ªói: Kh√¥ng th·ªÉ truy c·∫≠p camera ho·∫∑c microphone");
                document.getElementById('status').classList.replace("alert-info", "alert-danger");
                updateDebugInfo("L·ªói truy c·∫≠p camera: " + err.message);
            }
        }

        // T·∫°o k·∫øt n·ªëi ngang h√†ng
        function createPeerConnection() {
            if (peerConnection) {
                console.log("K·∫øt n·ªëi ƒë√£ t·ªìn t·∫°i.");
                return;
            }

            peerConnection = new RTCPeerConnection(config);
            updateDebugInfo("ƒê√£ t·∫°o RTCPeerConnection m·ªõi");

            // Th√™m track v√†o peer connection
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            // X·ª≠ l√Ω track nh·∫≠n ƒë∆∞·ª£c
            peerConnection.ontrack = event => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
                document.getElementById('endCallBtn').disabled = false;
                updateStatus("K·∫øt N·ªëi Th√†nh C√¥ng!");
                updateDebugInfo("ƒê√£ nh·∫≠n ƒë∆∞·ª£c media tracks t·ª´ ƒë·ªëi t√°c");
            };

            // Thu th·∫≠p ICE candidates
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    localICECandidates.push(event.candidate);
                    updateDebugInfo("ƒê√£ thu th·∫≠p ƒë∆∞·ª£c ICE candidate m·ªõi");
                }
            };

            // X·ª≠ l√Ω tr·∫°ng th√°i k·∫øt n·ªëi
            peerConnection.oniceconnectionstatechange = () => {
                const state = peerConnection.iceConnectionState;
                console.log("ICE connection state:", state);
                updateConnectionState(state);

                if (state === "connected" || state === "completed") {
                    updateStatus("K·∫øt N·ªëi Th√†nh C√¥ng!");
                } else if (state === "failed" || state === "disconnected") {
                    updateStatus("K·∫øt N·ªëi Th·∫•t B·∫°i. Th·ª≠ l·∫°i.");
                    document.getElementById('status').classList.replace("alert-info", "alert-warning");
                }

                updateDebugInfo("Tr·∫°ng th√°i ICE thay ƒë·ªïi: " + state);
            };
        }

        // T·∫°o l·ªùi m·ªùi (ng∆∞·ªùi g·ªçi)
        async function createOffer() {
            createPeerConnection();

            try {
                const offer = await peerConnection.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: true
                });
                await peerConnection.setLocalDescription(offer);
                updateDebugInfo("ƒê√£ t·∫°o v√† ƒë·∫∑t local description");

                // Ch·ªù ƒë·ªÉ thu th·∫≠p ICE candidates (th·ªùi gian ng·∫Øn h∆°n)
                updateStatus("ƒêang thu th·∫≠p ICE candidates...");
                await new Promise(resolve => setTimeout(resolve, collectCandidatesTime));

                // ƒê√≥ng g√≥i offer v√† ICE candidates
                const fullOffer = {
                    sdp: offer,
                    iceCandidates: localICECandidates,
                    timestamp: new Date().toISOString()
                };

                // L∆∞u l·∫°i ƒë·ªÉ debug
                lastOfferData = fullOffer;

                // M√£ h√≥a d·ª±a tr√™n c√†i ƒë·∫∑t
                const encodedOffer = encodeData(fullOffer);

                document.getElementById('offer').value = encodedOffer;
                document.getElementById('copyOfferBtn').disabled = false;

                // Hi·ªÉn th·ªã th√¥ng tin k√≠ch th∆∞·ªõc
                const sizeBefore = JSON.stringify(fullOffer).length;
                const sizeAfter = encodedOffer.length;
                const reduction = ((1 - sizeAfter / sizeBefore) * 100).toFixed(1);

                updateStatus("B∆∞·ªõc 3: Sao ch√©p L·ªùi M·ªùi v√† g·ª≠i cho ƒë·ªëi t√°c (Ng∆∞·ªùi g·ªçi)");
                updateDebugInfo(`ƒê√£ t·∫°o l·ªùi m·ªùi (gi·∫£m ${reduction}% k√≠ch th∆∞·ªõc), thu th·∫≠p ƒë∆∞·ª£c ${localICECandidates.length} ICE candidates, s·ª≠ d·ª•ng ${filterICECandidates(localICECandidates).length}`);
            } catch (err) {
                console.error("L·ªói khi t·∫°o l·ªùi m·ªùi:", err);
                alert("L·ªói: " + err.message);
                updateDebugInfo("L·ªói t·∫°o l·ªùi m·ªùi: " + err.message);
            }
        }

        // T·∫°o ph·∫£n h·ªìi (ng∆∞·ªùi nh·∫≠n)
        async function createAnswer() {
            try {
                const offerText = document.getElementById('offer').value.trim();
                if (!offerText) {
                    alert("Vui l√≤ng d√°n l·ªùi m·ªùi tr∆∞·ªõc khi t·∫°o ph·∫£n h·ªìi!");
                    return;
                }

                // Gi·∫£i m√£ offer
                const offerData = await decodeData(offerText);
                updateDebugInfo("ƒê√£ gi·∫£i m√£ l·ªùi m·ªùi th√†nh c√¥ng");

                if (!offerData || !offerData.sdp) {
                    throw new Error("L·ªùi m·ªùi kh√¥ng ch·ª©a th√¥ng tin SDP c·∫ßn thi·∫øt");
                }

                createPeerConnection();

                // ƒê·∫∑t remote description
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offerData.sdp));
                updateDebugInfo("ƒê√£ ƒë·∫∑t remote description t·ª´ l·ªùi m·ªùi");

                // Th√™m ICE candidates t·ª´ ng∆∞·ªùi g·ªçi
                if (offerData.iceCandidates && offerData.iceCandidates.length > 0) {
                    let addedCount = 0;
                    for (const candidate of offerData.iceCandidates) {
                        try {
                            await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                            addedCount++;
                        } catch (e) {
                            console.warn("Kh√¥ng th·ªÉ th√™m ICE candidate:", e);
                        }
                    }
                    updateDebugInfo(`ƒê√£ th√™m ${addedCount}/${offerData.iceCandidates.length} ICE candidates t·ª´ ng∆∞·ªùi g·ªçi`);
                } else {
                    updateDebugInfo("Kh√¥ng c√≥ ICE candidates trong l·ªùi m·ªùi");
                }

                // T·∫°o answer
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                updateDebugInfo("ƒê√£ t·∫°o v√† ƒë·∫∑t local description cho answer");

                // Ch·ªù ƒë·ªÉ thu th·∫≠p ICE candidates (th·ªùi gian ng·∫Øn h∆°n)
                updateStatus("ƒêang thu th·∫≠p ICE candidates...");
                await new Promise(resolve => setTimeout(resolve, collectCandidatesTime));

                // ƒê√≥ng g√≥i answer v√† ICE candidates
                const fullAnswer = {
                    sdp: answer,
                    iceCandidates: localICECandidates,
                    timestamp: new Date().toISOString()
                };

                // L∆∞u l·∫°i ƒë·ªÉ debug
                lastAnswerData = fullAnswer;

                // M√£ h√≥a d·ª±a tr√™n c√†i ƒë·∫∑t
                const encodedAnswer = encodeData(fullAnswer);

                document.getElementById('answer').value = encodedAnswer;
                document.getElementById('copyAnswerBtn').disabled = false;

                // Hi·ªÉn th·ªã th√¥ng tin k√≠ch th∆∞·ªõc
                const sizeBefore = JSON.stringify(fullAnswer).length;
                const sizeAfter = encodedAnswer.length;
                const reduction = ((1 - sizeAfter / sizeBefore) * 100).toFixed(1);

                updateStatus("B∆∞·ªõc 3: Sao ch√©p Ph·∫£n H·ªìi v√† g·ª≠i cho ng∆∞·ªùi g·ªçi (Ng∆∞·ªùi nh·∫≠n)");
                updateDebugInfo(`ƒê√£ t·∫°o ph·∫£n h·ªìi (gi·∫£m ${reduction}% k√≠ch th∆∞·ªõc), thu th·∫≠p ƒë∆∞·ª£c ${localICECandidates.length} ICE candidates, s·ª≠ d·ª•ng ${filterICECandidates(localICECandidates).length}`);
            } catch (err) {
                console.error("L·ªói khi t·∫°o ph·∫£n h·ªìi:", err);
                alert("L·ªói: " + err.message);
                updateDebugInfo("L·ªói t·∫°o ph·∫£n h·ªìi: " + err.message);
            }
        }

        // ƒê·∫∑t ph·∫£n h·ªìi (ng∆∞·ªùi g·ªçi)
        async function setAnswer() {
            try {
                const answerText = document.getElementById('answer').value.trim();
                if (!answerText) {
                    alert("Vui l√≤ng d√°n ph·∫£n h·ªìi tr∆∞·ªõc!");
                    return;
                }

                // Gi·∫£i m√£ answer
                const answerData = await decodeData(answerText);
                updateDebugInfo("ƒê√£ gi·∫£i m√£ ph·∫£n h·ªìi th√†nh c√¥ng");

                if (!answerData || !answerData.sdp) {
                    throw new Error("Ph·∫£n h·ªìi kh√¥ng ch·ª©a th√¥ng tin SDP c·∫ßn thi·∫øt");
                }

                // ƒê·∫∑t remote description t·ª´ answer
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answerData.sdp));
                updateDebugInfo("ƒê√£ ƒë·∫∑t remote description t·ª´ ph·∫£n h·ªìi");

                // Th√™m ICE candidates t·ª´ ng∆∞·ªùi nh·∫≠n
                if (answerData.iceCandidates && answerData.iceCandidates.length > 0) {
                    let addedCount = 0;
                    for (const candidate of answerData.iceCandidates) {
                        try {
                            await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                            addedCount++;
                        } catch (e) {
                            console.warn("Kh√¥ng th·ªÉ th√™m ICE candidate:", e);
                        }
                    }
                    updateDebugInfo(`ƒê√£ th√™m ${addedCount}/${answerData.iceCandidates.length} ICE candidates t·ª´ ng∆∞·ªùi nh·∫≠n`);
                } else {
                    updateDebugInfo("Kh√¥ng c√≥ ICE candidates trong ph·∫£n h·ªìi");
                }

                updateStatus("ƒêang K·∫øt N·ªëi...");
            } catch (err) {
                console.error("L·ªói khi ƒë·∫∑t ph·∫£n h·ªìi:", err);
                alert("L·ªói: " + err.message + "\n\nPh·∫£n h·ªìi kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng ho√†n ch·ªânh. H√£y ƒë·∫£m b·∫£o b·∫°n ƒë√£ sao ch√©p to√†n b·ªô ph·∫£n h·ªìi t·ª´ ƒë·ªëi t√°c.");
                updateDebugInfo("L·ªói ƒë·∫∑t ph·∫£n h·ªìi: " + err.message);
            }
        }

        // K·∫øt th√∫c cu·ªôc g·ªçi
        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                document.getElementById('localVideo').srcObject = null;
                document.getElementById('remoteVideo').srcObject = null;
            }

            // Reset c√°c tr·∫°ng th√°i
            localICECandidates = [];
            document.getElementById('offer').value = '';
            document.getElementById('answer').value = '';
            document.getElementById('copyOfferBtn').disabled = true;
            document.getElementById('copyAnswerBtn').disabled = true;
            document.getElementById('setAnswerBtn').disabled = true;
            document.getElementById('offerBtn').disabled = true;
            document.getElementById('answerBtn').disabled = true;
            document.getElementById('endCallBtn').disabled = true;

            document.getElementById('status').classList.replace("alert-info", "alert-danger");
            updateStatus("Cu·ªôc G·ªçi ƒê√£ K·∫øt Th√∫c");
            updateConnectionState("disconnected");
            updateDebugInfo("ƒê√£ k·∫øt th√∫c cu·ªôc g·ªçi v√† gi·∫£i ph√≥ng t√†i nguy√™n");

            // N√∫t b·∫Øt ƒë·∫ßu l·∫°i
            document.getElementById('startBtn').disabled = false;
        }

        // Ki·ªÉm tra v√† k√≠ch ho·∫°t c√°c n√∫t d·ª±a tr√™n n·ªôi dung
        function validateContent() {
            const offerValue = document.getElementById('offer').value.trim();
            const answerValue = document.getElementById('answer').value.trim();
            const hasLocalStream = !!localStream;

            if (role === "caller") {
                // Ng∆∞·ªùi g·ªçi
                document.getElementById('setAnswerBtn').disabled = !(answerValue && peerConnection);
            } else {
                // Ng∆∞·ªùi nh·∫≠n
                document.getElementById('answerBtn').disabled = !(offerValue && hasLocalStream);
            }
        }

        // Sao ch√©p v√†o clipboard
        function copyToClipboard(elementId) {
            const textToCopy = document.getElementById(elementId);
            textToCopy.select();
            document.execCommand('copy');

            // Hi·ªÉn th·ªã th√¥ng b√°o ƒë√£ sao ch√©p
            const buttonId = elementId === 'offer' ? 'copyOfferBtn' : 'copyAnswerBtn';
            const originalText = document.getElementById(buttonId).innerText;
            document.getElementById(buttonId).innerText = '‚úì ƒê√£ sao ch√©p!';

            setTimeout(() => {
                document.getElementById(buttonId).innerText = originalText;
            }, 2000);

            updateDebugInfo(`ƒê√£ sao ch√©p ${elementId === 'offer' ? 'l·ªùi m·ªùi' : 'ph·∫£n h·ªìi'} v√†o clipboard`);
        }

        // Hi·ªÉn th·ªã th√¥ng tin debug
        function showDebugInfo(type) {
            try {
                const content = document.getElementById(type).value.trim();
                if (!content) {
                    alert(`Ch∆∞a c√≥ ${type === 'offer' ? 'l·ªùi m·ªùi' : 'ph·∫£n h·ªìi'} ƒë·ªÉ hi·ªÉn th·ªã!`);
                    return;
                }

                // Th·ª≠ gi·∫£i m√£ v√† hi·ªÉn th·ªã th√¥ng tin
                try {
                    const data = decodeData(content);

                    // Hi·ªÉn th·ªã th√¥ng tin trong debug log
                    if (data.sdp) {
                        updateDebugInfo(`${type === 'offer' ? 'L·ªùi m·ªùi' : 'Ph·∫£n h·ªìi'} h·ª£p l·ªá, c√≥ ${data.iceCandidates ? data.iceCandidates.length : 0} ICE candidates`);
                    }

                    const prettifiedJSON = JSON.stringify(data, null, 2);
                    const previewLength = 300; // S·ªë k√Ω t·ª± ƒë·ªÉ hi·ªÉn th·ªã trong alert

                    alert(`${type === 'offer' ? 'L·ªùi m·ªùi' : 'Ph·∫£n h·ªìi'} h·ª£p l·ªá:\n\n${prettifiedJSON.length > previewLength ? prettifiedJSON.substring(0, previewLength) + "..." : prettifiedJSON}`);
                } catch (err) {
                    alert(`L·ªói khi ph√¢n t√≠ch ${type === 'offer' ? 'l·ªùi m·ªùi' : 'ph·∫£n h·ªìi'}: ${err.message}`);
                }
            } catch (err) {
                alert("L·ªói khi hi·ªÉn th·ªã th√¥ng tin debug: " + err.message);
            }
        }

        // Kh·ªüi t·∫°o UI theo vai tr√≤ khi trang t·∫£i
        updateRoleUI();
    </script>
</body>

</html>